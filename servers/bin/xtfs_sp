#!/bin/bash
# a tool for getting and setting striping policies of XtreemFS directories

usage() {
		echo "Usage: xtfs_sp get|set|del <directory> [<new_policy>]"
		echo "example: xtfs_sp set ./xtreemfs-mount/mydir RAID0,4,2"
		exit 1
}

check() {
	if [ ! -e "`which setfattr`" -o ! -e "`which getfattr`" ]; then
		echo "Could not find at least one of the commands 'setfattr' or 'getfattr'."
		echo "Please make sure that the 'attr' package is installed, and both commands are in the search path."
		exit 1
	elif [ $NUM_ARGS -lt 2 ]; then
		echo $#
		usage
	fi
}

export NUM_ARGS=$#
check

if [ "$1" == "set" ]; then
	setfattr -n xtreemfs.default_sp -v $3 $2
elif [ "$1" == "get" ]; then
	export SP=`getfattr -m xtreemfs.default_sp --only-values $2`
	if [ -e "$2" -a -z "$SP" ]; then
		echo "no default striping policy set on '$2'"
	else
		if [ -e "$2" ]; then
			echo $SP
		fi
	fi
elif [ "$1" == "del" ]; then
	setfattr -n xtreemfs.default_sp -v "null" $2
else
	echo "invalid operand: $1"
	usage
fi
exit $?
